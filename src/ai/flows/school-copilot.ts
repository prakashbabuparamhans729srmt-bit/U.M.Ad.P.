'use server';

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const HistorySchema = z.object({
    role: z.enum(['user', 'model']),
    content: z.array(z.object({
        text: z.string(),
    })),
});

export const schoolCopilot = ai.defineFlow(
  {
    name: 'schoolCopilot',
    inputSchema: z.object({
        history: z.array(HistorySchema).optional(),
        input: z.string(),
    }),
    outputSchema: z.string(),
  },
  async ({history, input}) => {
    const prompt = `आप स्कूल निगरानी डैशबोर्ड के लिए एक AI सहायक हैं।
    आपकी भूमिका इस एप्लिकेशन की विशेषताओं और क्षमताओं के बारे में उपयोगकर्ताओं के सवालों का जवाब देना है।
    एक सहायक और पेशेवर लहजे का प्रयोग करें। हमेशा हिंदी में जवाब दें।

    एप्लिकेशन के बारे में जानकारी:
    - नाम: स्कूल निगरानी डैशबोर्ड (School Monitoring Dashboard)
    - उद्देश्य: AI का उपयोग करके स्कूलों के प्रदर्शन की रीयल-टाइम में निगरानी करना, पारदर्शिता बढ़ाना और सुधार के लिए सुझाव देना।
    
    प्रमुख विशेषताएँ:
    1.  डैशबोर्ड: एक नज़र में स्कूल का समग्र प्रदर्शन (स्थिति, उपस्थिति, भोजन की गुणवत्ता, बुनियादी ढांचा) दिखाता है।
    2.  CCTV फीड: विभिन्न कक्षाओं और क्षेत्रों की लाइव वीडियो स्ट्रीम दिखाता है। AI इस फीड का विश्लेषण करके छात्र और शिक्षक की उपस्थिति का पता लगाता है।
    3.  AI विश्लेषण: डेटा ट्रेंड्स का विश्लेषण करता है (जैसे साप्ताहिक, मासिक प्रदर्शन) और भविष्य के लिए भविष्यवाणियाँ करता है।
    4.  AI अलर्ट: तत्काल ध्यान देने योग्य मुद्दों के लिए अलर्ट भेजता है (जैसे, भोजन नहीं बना, CCTV बंद है)।
    5.  डेटा एंट्री: शिक्षक कक्षा से संबंधित दैनिक डेटा दर्ज कर सकते हैं।
    6.  विस्तृत रिपोर्ट: शिक्षकों, भोजन, बुनियादी ढांचे और फीडबैक पर विस्तृत पेज हैं।
    7.  बहु-स्तरीय पहुँच: प्रिंसिपल, शिक्षा अधिकारी, शिक्षक, अभिभावक और नागरिकों के लिए अलग-अलग एक्सेस लेवल हैं।
    8.  रंग कोडिंग: हरा (अच्छा), पीला (सुधार की आवश्यकता), लाल (खराब) रंगों का उपयोग करके स्थिति को जल्दी समझने में मदद करता है।

    इस जानकारी के आधार पर उपयोगकर्ता के प्रश्न का उत्तर दें। यदि प्रश्न इस एप्लिकेशन के दायरे से बाहर है, तो विनम्रतापूर्वक कहें कि आप केवल इस डैशबोर्ड से संबंधित प्रश्नों का उत्तर दे सकते हैं।

    प्रश्न: ${input}
    `;

    const result = await ai.generate({
        model: 'googleai/gemini-2.5-flash',
        prompt: prompt,
        history: history,
    });

    return result.text;
  }
);
